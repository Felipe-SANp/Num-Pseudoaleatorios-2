<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Corridas Arriba y Abajo</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../JS/TableDNS.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h2>Prueba de Corridas Arriba y Abajo de la media</h2><br>
    <div class="container-sm input-group row mb-3">
        <label for="efficience" class="form-label">Nivel de confianza (%)</label>
        <input type="number" class="form-control" id="efficience" placeholder="95">
        <p></p>
        <label for="fileInput" class="form-label ">Sube un archivo Excel con una serie de números en la primera columna</label>
        <input class="form-control" type="file" id="fileInput" accept=".xlsx">
        <p></p>
    </div>

    <div class="container-sm row input-group mb-3">
        <button class="btn btn-success" onclick="processFile()" type="button" id="button-addon2">Calcular Corridas</button>
    </div>

    <div class="result" id="result" style="display: none;"></div><br>
    <div id="card" style="display: none;"></div>

    <script>
        function processFile() {
            const efficience = parseInt(document.getElementById("efficience").value);
            const input = document.getElementById("fileInput").files[0];

            if (efficience < 0 || efficience > 100 || isNaN(efficience)) {
                alert("Por favor, ingrese un porcentaje de nivel de confianza aceptable.");
                return;
            }

            if (!input) {
                alert("Por favor, selecciona un archivo Excel.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const numbers = jsonData.map(row => row[0]).filter(value => typeof value === 'number' && !isNaN(value));

                    if (numbers.length === 0) {
                        throw new Error("No se encontraron números válidos en el archivo.");
                    }
                    calculateRuns(numbers, efficience.toFixed(2));
                } catch (error) {
                    document.getElementById("result").innerText = `Error al procesar el archivo: ${error.message}`;
                }
            };
            reader.readAsArrayBuffer(input);
        }

        function calculateRuns(numbers, efficience) {
            // Generar secuencia de diferencias (arriba/abajo)
            const runs = [];
            for (let i = 0; i < numbers.length; i++) {
                runs.push(numbers[i] <= 0.5 ? '0' : '1');
            }

            // Contar las corridas
            let runCount = 1;
            for (let i = 1; i < runs.length; i++) {
                if (runs[i] !== runs[i - 1]) {
                    runCount++;
                }
            }

            const n0 = runs.filter(r => r === '0').length;
            const n1 = runs.filter(r => r === '1').length;
            const n = numbers.length;

            const mu_c = (2 * n0 * n1) / n + 0.5;
            const sigma_c_squared = (2 * n0 * n1 * (2 * n0 * n1 - n)) / (n * n * (n - 1));
            const sigma_c = Math.sqrt(sigma_c_squared);
            const Z0 = (runCount - mu_c) / sigma_c;

            const alpha = 1 - efficience / 100;
            const Ze = TableDNS.search(alpha / 2);

            const hipostesis = (Z0 > -Ze && Z0 < Ze) 
                ? 'No se rechaza la hipótesis de nula indepencia y se concluye que la serie es aleatoria'
                : 'Se rechaza la hipótesis de nula independencia';

            document.getElementById("result").innerHTML = `
                <p>Secuencia: ${runs.join(', ')}</p>
                <p>Número de corridas observadas (C₀): ${runCount}</p>
                <p>n₀ (corridas abajo): ${n0}</p>
                <p>n₁ (corridas arriba): ${n1}</p>
                <p>Media esperada de corridas (μ₀): ${mu_c.toFixed(4)}</p>
                <p>Varianza de corridas (σ²₀): ${sigma_c_squared.toFixed(4)}</p>
                <p>Desviación estándar (σ₀): ${sigma_c.toFixed(4)}</p>
                <p>Valor Z₀: ${Z0.toFixed(4)}</p>
                <p>Valor Z<sub>e</sub>: ${Ze.toFixed(2)}</p>
            `;

            document.getElementById("card").innerHTML = `
                <div class="alert alert-warning" role="alert">
                        <p>Con un nivel de confianza del ${efficience}%, ${hipostesis}.</p>
                    </div>
            `;
            document.getElementById("result").style.display = 'block';
            document.getElementById("card").style.display = 'block';
        }
    </script>
</body>
</html>